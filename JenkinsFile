pipeline {
	agent any
	environment {
        GITHUB_CREDENTIALS = credentials('github-credentials-id') 

	stages {

        stage("Git Clone o Actualizar(pull)"){
            steps{
                withCredentials([usernamePassword(credentialsId:'GITHUB_CREDENCIAL', usernameVariable:'GITHUB_USERNAME', passwordVariable:'GITHUB_PASSWORD')]){
                sh '''
                 chmod -R +x /var/lib/jenkins/workspace/Proyecto-IngSof_main/scripts
                 chmod +x /var/lib/jenkins/workspace/Proyecto-IngSof_main/scripts/GitClone-Pull.sh
                ./scripts/GitClone-Pull.sh
                '''
               }
            }
        }

        //se ejecuta solo si esta en la rama desarrollo
    	stage('Desarrollo') {
            //se ejecuta solo si esta en esta rama
            when {
                branch 'Desarrollo'
            }
        	steps {
            	echo "Sincronizando los cambios en desarrollo"
            	sh '''
					chmod -R +x /var/lib/jenkins/workspace/Proyecto-IngSof_Desarrollo/scripts
                    chmod  +x /var/lib/jenkins/workspace/Proyecto-IngSof_Desarrollo/scripts/BranchDesarrollo.sh
					/var/lib/jenkins/workspace/Proyecto-IngSof_Desarrollo/scripts/BranchDesarrollo.sh
            	
            	'''
        	}
    	}
        stage('Fusionar a Pruebas'){
             when {
                branch 'Pruebas'
            }
            steps{
                echo "Fusionando desarrollo a pruebas"
            	sh '''
				    chmod +x /var/lib/jenkins/workspace/Proyecto-IngSof_Pruebas/scripts/BranchPruebas.sh
                	/var/lib/jenkins/workspace/Proyecto-IngSof_Pruebas/scripts/BranchPruebas.sh
            	'''
            }
        }
        stage('Desplegar en pruebas') {
			 when {
                branch 'Pruebas'
            }
        	steps {
            	echo "Desplegando en servidor de pruebas"
            	sh '''
                	chmod +x /var/lib/jenkins/workspace/Proyecto-IngSof_Pruebas/scripts/DesplieguePruebas.sh
                	/var/lib/jenkins/workspace/Proyecto-IngSof_Pruebas/scripts/DesplieguePruebas.sh
            	'''
        	}
    	}
        stage('Sincronizacion a Produccion') {
    	steps {
			 script {
                    REPO_DIR = "/var/lib/jenkins/workspace/Clone_Repository/Jenkins_Proyecto"
                    BRANCH = "main"
                    TESTING_BRANCH = "Pruebas"

                    // Verificar que el repositorio ya esté en el directorio
                    dir(REPO_DIR) {
                        // Asegurarnos de estar en el directorio del repositorio y de hacer un checkout de la rama principal
                        sh 'git fetch origin'
                        sh 'git checkout $BRANCH'
                        
                        // Hacer el merge de la rama de pruebas a la principal
                        sh 'git merge origin/$TESTING_BRANCH'

                        // Empujar los cambios a la rama principal en el repositorio remoto
                        sh 'git push origin $BRANCH'

                        // Mensaje final de sincronización
                        echo "CAMBIOS SINCRONIZADOS CORRECTAMENTE A PRODUCCION"
                    }
                }
			}
			
    
    }
    	
  }
}
